name: CI - fb (Firebird Ruby Driver)

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    name: Minitest Tests
    runs-on: ubuntu-22.04

    services:
      firebird:
        image: firebirdsql/firebird:5.0.3
        env:
          FIREBIRD_ROOT_PASSWORD: masterkey
        options: >-
          --health-cmd "bash -c 'echo \"SELECT 1 FROM RDB\\\$DATABASE;\" | isql-fb -user SYSDBA -password masterkey localhost 2>&1 | grep -q \"1\"' || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 15
        ports:
          - 3050:3050

    steps:
      - uses: actions/checkout@v4

      # -------------------------------
      # Extraer libfbclient + headers
      # desde el contenedor Firebird 5
      # -------------------------------
      - name: Extract Firebird client from container
        run: |
          set -e

          CONTAINER=$(docker ps --filter "ancestor=firebirdsql/firebird:5.0.3" --format "{{.Names}}" | head -n1)
          echo "Using Firebird container: $CONTAINER"

          echo "Searching libfbclient.so.5 inside container..."
          docker exec $CONTAINER find / -name "libfbclient.so.5" 2>/dev/null

          FBCLIENT_PATH=$(docker exec $CONTAINER sh -c 'find / -name "libfbclient.so.5" 2>/dev/null | head -n1')

          if [ -z "$FBCLIENT_PATH" ]; then
            echo "❌ libfbclient.so.5 not found in container"
            exit 1
          fi

          echo "Found libfbclient at: $FBCLIENT_PATH"
          docker cp $CONTAINER:$FBCLIENT_PATH .
          sudo cp libfbclient.so.5 /usr/lib/
          sudo ldconfig

          echo "Copying Firebird headers..."
          HEADER_PATH=$(docker exec $CONTAINER sh -c 'find / -name ibase.h 2>/dev/null | head -n1 | xargs dirname')

          if [ -z "$HEADER_PATH" ]; then
            echo "❌ ibase.h not found in container"
            exit 1
          fi

          echo "Found headers at: $HEADER_PATH"
          docker cp $CONTAINER:$HEADER_PATH ./firebird_headers
          sudo cp -r firebird_headers/* /usr/include/

      # -------------------------------
      # Ruby
      # -------------------------------
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.6'

      # -------------------------------
      # Compilar extensión nativa
      # -------------------------------
      - name: Build extension
        run: |
          ruby extconf.rb
          make

      # -------------------------------
      # Verificación ABI (crítica)
      # -------------------------------
      - name: Verify Firebird client linkage
        run: |
          ldd ./fb.so | grep fbclient

      # -------------------------------
      # Esperar Firebird
      # -------------------------------
      - name: Wait for Firebird
        run: |
          echo "Waiting for Firebird..."
          for i in {1..60}; do
            if nc -z localhost 3050 2>/dev/null; then
              echo "✓ Port 3050 is open"
              break
            fi
            sleep 1
          done

          for i in {1..30}; do
            if echo "SELECT 1 FROM RDB\$DATABASE;" | isql-fb -user SYSDBA -password masterkey localhost 2>/dev/null | grep -q "1"; then
              echo "✓ Firebird responding"
              exit 0
            fi
            sleep 1
          done

          echo "❌ Firebird not responding"
          exit 1

      # -------------------------------
      # Directorio de datos
      # -------------------------------
      - name: Prepare Firebird data dir
        run: |
          CONTAINER=$(docker ps --filter "ancestor=firebirdsql/firebird:5.0.3" --format "{{.Names}}" | head -n1)
          docker exec $CONTAINER mkdir -p /firebird/data
          docker exec $CONTAINER chown -R firebird:firebird /firebird/data

      # -------------------------------
      # Ejecutar tests
      # -------------------------------
      - name: Run Tests
        env:
          FIREBIRD_HOST: localhost
          FIREBIRD_PORT: 3050
          FIREBIRD_USER: SYSDBA
          FIREBIRD_PASSWORD: masterkey
          FIREBIRD_DATA_DIR: /firebird/data
          LANG: en_US.UTF-8
          LC_ALL: en_US.UTF-8
        run: |
          ruby -Ilib:test test/FbTestSuite.rb --verbose --backtrace
