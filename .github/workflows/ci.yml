name: CI - fb (Firebird Ruby Driver)

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ubuntu-22.04

    services:
      firebird:
        image: firebirdsql/firebird:5.0.3
        env:
          FIREBIRD_ROOT_PASSWORD: masterkey
        ports:
          - 3050:3050
        options: >-
          --health-cmd "bash -c 'echo \"SELECT 1 FROM RDB\\\$DATABASE;\" | isql-fb -user SYSDBA -password masterkey localhost | grep -q 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 15

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------
      # Firebird 5 client (official tarball)
      # -----------------------------------
      - name: Install Firebird 5 client
        run: |
          set -e

          sudo apt-get update
          sudo apt-get install -y curl libncurses5 libtinfo5

          curl -fL -o firebird.tar.gz \
            https://github.com/FirebirdSQL/firebird/releases/download/v5.0.3/Firebird-5.0.3.1683-0-linux-x64.tar.gz

          tar -xzf firebird.tar.gz

          FB_DIR=$(tar -tf firebird.tar.gz | head -1 | cut -d/ -f1)
          echo "Using Firebird dir: $FB_DIR"

          cd "$FB_DIR"
          sudo ./install.sh -silent

          echo "/opt/firebird/lib" | sudo tee /etc/ld.so.conf.d/firebird.conf
          sudo ldconfig

          /opt/firebird/bin/isql-fb -z

      # -------------------------------
      # Ruby
      # -------------------------------
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.6'

      # -------------------------------
      # Build native extension
      # -------------------------------
      - name: Build extension
        env:
          FIREBIRD_HOME: /opt/firebird
        run: |
          ruby extconf.rb \
            --with-firebird-include=/opt/firebird/include \
            --with-firebird-lib=/opt/firebird/lib
          make

      # -------------------------------
      # Verify ABI
      # -------------------------------
      - name: Verify Firebird linkage
        run: |
          ldd ./fb.so | grep fbclient

      # -------------------------------
      # Wait for Firebird
      # -------------------------------
      - name: Wait for Firebird
        run: |
          for i in {1..30}; do
            if echo "SELECT 1 FROM RDB\$DATABASE;" | \
              isql-fb -user SYSDBA -password masterkey localhost | grep -q 1; then
              exit 0
            fi
            sleep 1
          done
          echo "Firebird not responding"
          exit 1

      # -------------------------------
      # Run tests
      # -------------------------------
      - name: Run Tests
        env:
          FIREBIRD_HOST: localhost
          FIREBIRD_PORT: 3050
          FIREBIRD_USER: SYSDBA
          FIREBIRD_PASSWORD: masterkey
          LANG: en_US.UTF-8
          LC_ALL: en_US.UTF-8
        run: |
          ruby -Ilib:test test/FbTestSuite.rb --verbose --backtrace
