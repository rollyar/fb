name: CI - fb (Firebird Ruby Driver)

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ubuntu-24.04

    services:
      firebird:
        image: firebirdsql/firebird:latest
        env:
          FIREBIRD_ROOT_PASSWORD: masterkey
        ports:
          - 3050:3050
    steps:
      - uses: actions/checkout@v4

      # -----------------------------------
      # Firebird 5 client (official tarball)
      # -----------------------------------
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y firebird-dev libfbclient2 netcat-openbsd ruby-dev
          if [ -d /usr/include/firebird ] && [ ! -f /usr/include/ibase.h ]; then
            sudo ln -sf /usr/include/firebird/ibase.h /usr/include/ibase.h
          fi

      # -------------------------------
      # Ruby
      # -------------------------------
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.6'

      # -------------------------------
      # Build native extension
      # -------------------------------
      - name: Build extension
        run: |
          ruby extconf.rb
          make

      # -------------------------------
      # Verify ABI
      # -------------------------------
      - name: Verify Firebird linkage
        run: |
          ldd ./fb.so | grep fbclient

      # -------------------------------
      # Wait for Firebird
      # -------------------------------
      - name: Wait for Firebird
        run: |
          for i in {1..30}; do
            if echo "SELECT 1 FROM RDB\$DATABASE;" | \
              isql-fb -user SYSDBA -password masterkey localhost | grep -q 1; then
              exit 0
            fi
            sleep 1
          done
          echo "Firebird not responding"
          exit 1

      # -------------------------------
      # Run tests
      # -------------------------------
      - name: Run Tests
        env:
          FIREBIRD_HOST: localhost
          FIREBIRD_PORT: 3050
          FIREBIRD_USER: SYSDBA
          FIREBIRD_PASSWORD: masterkey
          LANG: en_US.UTF-8
          LC_ALL: en_US.UTF-8
        run: |
          ruby -Ilib:test test/FbTestSuite.rb --verbose --backtrace
